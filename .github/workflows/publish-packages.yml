# è‡ªåŠ¨å‘å¸ƒåŒ…åˆ° NPM

name: ðŸ§¿ Publish changed packages

# è°¢è°¢ä½  Fairy ðŸ§¿

on:
  push:
    branches: [ master ]
    paths:
      - "packages/**"  # ä»…å½“ packages/ å˜åŒ–æ—¶è§¦å‘

permissions:
  contents: write
  pull-requests: read

# ä¸å…è®¸åŒæ—¶è¿›è¡Œå¤šä¸ªéƒ¨ç½²ï¼Œè·³è¿‡éžæ­£åœ¨è¿è¡Œã€éžæœ€æ–°é˜Ÿåˆ—çš„è¿è¡Œé˜Ÿåˆ—ï¼Œä¸”ä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„å·¥ä½œæµ
concurrency:
  group: publish
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # [Publishing packages with provenance via GitHub Actions](https://docs.npmjs.com/generating-provenance-statements)
      contents: write # åˆ›å»º Release è¦ç”¨è¿™ä¸ªæƒé™
    environment: production
    steps:
      - name: ðŸ“‹ï¸ Checkout code # èŽ·å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ“¦ Setup Node # å®‰è£… Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: ðŸ”Ž Detect changed packages # æ£€æŸ¥å­åŒ…çš„ version æ˜¯å¦æœ‰å˜åŒ–
        id: detect
        run: |
          set -e
          echo "[]" > changed.json
          pkgs=()
          for pkg in packages/*; do
            if [ -f "$pkg/package.json" ]; then
              CURRENT=$(node -p "require('./$pkg/package.json').version")
              git checkout HEAD^ -- "$pkg/package.json" || continue
              PREV=$(node -p "require('./$pkg/package.json').version")
              git checkout -f HEAD -- "$pkg/package.json"
              if [ "$CURRENT" != "$PREV" ]; then
                pkgs+=("$pkg")
                echo "Package $pkg changed: $PREV -> $CURRENT"
              fi
            fi
          done
          if [ ${#pkgs[@]} -eq 0 ]; then
            echo "No changed packages"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            printf '%s\n' "${pkgs[@]}" > changed.txt
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "changed_list=$(cat changed.txt)" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Publish changed packages
        if: steps.detect.outputs.changed == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -e
          while IFS= read -r pkg; do
            echo "Publishing $pkg"
            cd "$pkg"
            npm publish --access public --provenance
            cd -
          done < changed.txt
